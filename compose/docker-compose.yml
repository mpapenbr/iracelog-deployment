
version: '3.1'

services:

  db:
    build: 
      context: postgres
      args: 
        postgres_tag: 13
    image: dev/iracelog-db:13
    restart: always
    volumes: 
      - db-data:/var/lib/postgresql/data
      - /var/local/dumps:/dumps
    
    environment:
      TZ: "Europe/Berlin"
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} 
      DB_USER_NAME: ${DB_USER_NAME} 
      DB_USER_PASSWORD: ${DB_USER_PASSWORD} 
      
    networks: 
      - somenet
  
  crossbar:    
    image: crossbario/crossbar:cpy-amd64-21.2.1   
    restart: always 
    networks:
      - somenet    
      - extnet
    environment:
      TZ: "Europe/Berlin"
      VIRTUAL_PORT: 8080
      VIRTUAL_HOST: ${CROSSBAR_DOMAIN}
      LETSENCRYPT_HOST: ${CROSSBAR_DOMAIN}
      LETSENCRYPT_EMAIL: ${DOMAIN_OWNER_EMAIL}
      CROSSBAR_DATAPROVIDER_TICKET: ${CROSSBAR_DATAPROVIDER_TICKET}
      CROSSBAR_BACKEND_TICKET: ${CROSSBAR_BACKEND_TICKET}
      CROSSBAR_ADMIN_TICKET: ${CROSSBAR_ADMIN_TICKET}
    volumes:
      - $PWD/config/crossbar/cb-racelog.json:/node/.crossbar/config.json

  # iracelog-service-manager
  ism-manager:      
    image: ghcr.io/mpapenbr/iracelog-service-manager:v0.2.2
    restart: always
    networks: 
      - somenet
      
    environment:
      TZ: "Europe/Berlin"
      RACELOG_URL: ${RACELOG_URL}
      RACELOG_REALM: ${RACELOG_REALM}
      RACELOG_USER: ${RACELOG_USER}
      RACELOG_PASSWORD: ${CROSSBAR_BACKEND_TICKET}
      DB_URL: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog
      
    command: "ism --check http://crossbar:8080/info manager"
    depends_on:
      - db
      - crossbar
  
  ism-archiver:      
    image: ghcr.io/mpapenbr/iracelog-service-manager:v0.2.2
    restart: always
    networks: 
      - somenet
    
    environment:
      TZ: "Europe/Berlin"
      RACELOG_URL: ${RACELOG_URL}
      RACELOG_REALM: ${RACELOG_REALM}
      RACELOG_USER: ${RACELOG_USER}
      RACELOG_PASSWORD: ${CROSSBAR_BACKEND_TICKET}
      DB_URL: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog

    command: "ism --check http://crossbar:8080/info archiver"
    depends_on:
      - db
      - crossbar

  # iracelog-analysis-service
  ias:    
    image: ghcr.io/mpapenbr/iracelog-analysis-service:v0.1.1
    restart: always
    networks: 
      - somenet    
    
    environment:
      TZ: "Europe/Berlin"
      CROSSBAR_URL: ${RACELOG_URL}
      CROSSBAR_REALM: ${RACELOG_REALM}
      CROSSBAR_USER: ${RACELOG_USER}
      CROSSBAR_CREDENTIALS: ${CROSSBAR_BACKEND_TICKET}
      DB_URL: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog
    
    depends_on:
      - db
      - crossbar

  # the frontend
  iracelog:
    image: ghcr.io/mpapenbr/iracelog-web:v0.11.1    
    restart: always
    networks: 
      - somenet
      - extnet
    environment:
      VIRTUAL_PORT: 80
      VIRTUAL_HOST: ${FRONTEND_DOMAIN}
      LETSENCRYPT_HOST: ${FRONTEND_DOMAIN}
      LETSENCRYPT_EMAIL: ${DOMAIN_OWNER_EMAIL}
      TZ: "Europe/Berlin"
    volumes:
      - $PWD/config/iracelog/frontend.json:/usr/share/nginx/html/config.json
    
  
  db-migrate:      
    image: ghcr.io/mpapenbr/iracelog-service-manager:v0.2.2    
    networks: 
      - somenet    
    environment:      
      DB_URL: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog

    command: "./wait-for-it.sh -h db -p 5432 -s -- alembic -c src/iracelog_service_manager/db/alembic.ini  upgrade head"
    depends_on:
      - db
      
  main-services:
    image: busybox
    command: sh -c "Starting services"
    depends_on:
      - db
      - crossbar
      - ism-manager
      - ism-archiver
      - ias
      - iracelog


volumes:  
  db-data:
  backup:

networks:
  somenet:
  extnet:
    external: 
      name: nginx_mynet
  